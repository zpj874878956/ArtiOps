{% extends 'base.html' %}

{% block title %}SSH凭证管理 - 运维平台{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">SSH凭证管理</h3>
                    <div class="card-tools">
                        <button type="button" class="btn btn-primary btn-sm" data-toggle="modal" data-target="#addCredentialModal">
                            <i class="fas fa-plus"></i> 添加凭证
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <!-- 搜索框 -->
                    <div class="row mb-3">
                        <div class="col-md-6 offset-md-6">
                            <div class="input-group">
                                <input type="text" class="form-control" id="searchInput" placeholder="搜索凭证名称/用户名">
                                <div class="input-group-append">
                                    <button class="btn btn-default" id="searchBtn">
                                        <i class="fas fa-search"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 凭证列表表格 -->
                    <div class="table-responsive">
                        <table class="table table-bordered table-striped">
                            <thead>
                                <tr>
                                    <th style="width: 40px">
                                        <input type="checkbox" id="selectAll">
                                    </th>
                                    <th>名称</th>
                                    <th>用户名</th>
                                    <th>认证类型</th>
                                    <th>关联主机数</th>
                                    <th>创建人</th>
                                    <th>创建时间</th>
                                    <th style="width: 150px">操作</th>
                                </tr>
                            </thead>
                            <tbody id="credentialTableBody">
                                <!-- 凭证数据将通过AJAX加载 -->
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- 分页控件 -->
                    <div class="row mt-3">
                        <div class="col-sm-12 col-md-5">
                            <div class="dataTables_info" id="paginationInfo" role="status" aria-live="polite">
                                显示第 1 至 10 项，共 0 项
                            </div>
                        </div>
                        <div class="col-sm-12 col-md-7">
                            <div class="dataTables_paginate paging_simple_numbers" id="pagination">
                                <ul class="pagination">
                                    <li class="paginate_button page-item previous disabled">
                                        <a href="#" class="page-link">上一页</a>
                                    </li>
                                    <li class="paginate_button page-item active">
                                        <a href="#" class="page-link">1</a>
                                    </li>
                                    <li class="paginate_button page-item next disabled">
                                        <a href="#" class="page-link">下一页</a>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 添加凭证模态框 -->
<div class="modal fade" id="addCredentialModal" tabindex="-1" role="dialog" aria-labelledby="addCredentialModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addCredentialModalLabel">添加SSH凭证</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="addCredentialForm">
                    <div class="form-group">
                        <label for="name">凭证名称 <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="name" name="name" required>
                        <small class="form-text text-muted">用于标识此凭证的名称，如"生产环境root用户"</small>
                    </div>
                    <div class="form-group">
                        <label for="username">用户名 <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="username" name="username" required>
                    </div>
                    <div class="form-group">
                        <label>认证类型 <span class="text-danger">*</span></label>
                        <div class="custom-control custom-radio">
                            <input type="radio" id="authTypePassword" name="auth_type" value="password" class="custom-control-input" checked>
                            <label class="custom-control-label" for="authTypePassword">密码认证</label>
                        </div>
                        <div class="custom-control custom-radio">
                            <input type="radio" id="authTypeKey" name="auth_type" value="key" class="custom-control-input">
                            <label class="custom-control-label" for="authTypeKey">密钥认证</label>
                        </div>
                    </div>
                    <div id="passwordAuthSection">
                        <div class="form-group">
                            <label for="password">密码 <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <input type="password" class="form-control" id="password" name="password">
                                <div class="input-group-append">
                                    <button class="btn btn-outline-secondary toggle-password" type="button">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="keyAuthSection" style="display: none;">
                        <div class="form-group">
                            <label for="private_key">私钥 <span class="text-danger">*</span></label>
                            <textarea class="form-control" id="private_key" name="private_key" rows="5"></textarea>
                            <small class="form-text text-muted">请粘贴私钥内容，通常以 -----BEGIN RSA PRIVATE KEY----- 开头</small>
                        </div>
                        <div class="form-group">
                            <label for="passphrase">私钥密码</label>
                            <div class="input-group">
                                <input type="password" class="form-control" id="passphrase" name="passphrase">
                                <div class="input-group-append">
                                    <button class="btn btn-outline-secondary toggle-password" type="button">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                            </div>
                            <small class="form-text text-muted">如果私钥没有密码保护，请留空</small>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="hosts">关联主机</label>
                        <select class="form-control select2" id="hosts" name="hosts" multiple>
                            <!-- 主机选项将通过AJAX加载 -->
                        </select>
                        <small class="form-text text-muted">可选择要应用此凭证的主机</small>
                    </div>
                    <div class="form-group">
                        <label for="description">描述</label>
                        <textarea class="form-control" id="description" name="description" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                <button type="button" class="btn btn-info" id="testCredentialBtn">测试连接</button>
                <button type="button" class="btn btn-primary" id="saveCredentialBtn">保存</button>
            </div>
        </div>
    </div>
</div>

<!-- 凭证详情模态框 -->
<div class="modal fade" id="credentialDetailModal" tabindex="-1" role="dialog" aria-labelledby="credentialDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="credentialDetailModalLabel">凭证详情</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div id="credentialDetailContent">
                    <!-- 凭证详情将通过AJAX加载 -->
                </div>
                <div class="mt-4">
                    <h5>关联主机列表</h5>
                    <div class="table-responsive">
                        <table class="table table-bordered table-striped">
                            <thead>
                                <tr>
                                    <th>主机名</th>
                                    <th>IP地址</th>
                                    <th>状态</th>
                                    <th>系统类型</th>
                                </tr>
                            </thead>
                            <tbody id="credentialHostsTableBody">
                                <!-- 凭证关联的主机列表将通过AJAX加载 -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">关闭</button>
                <button type="button" class="btn btn-primary" id="editCredentialBtn">编辑</button>
            </div>
        </div>
    </div>
</div>

<!-- 测试连接模态框 -->
<div class="modal fade" id="testConnectionModal" tabindex="-1" role="dialog" aria-labelledby="testConnectionModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="testConnectionModalLabel">测试SSH连接</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="testConnectionForm">
                    <div class="form-group">
                        <label for="test_host">主机 <span class="text-danger">*</span></label>
                        <select class="form-control" id="test_host" name="test_host" required>
                            <option value="">请选择主机</option>
                            <!-- 主机选项将通过AJAX加载 -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="test_port">端口</label>
                        <input type="number" class="form-control" id="test_port" name="test_port" value="22">
                    </div>
                </form>
                <div id="testConnectionResult" style="display: none;">
                    <div class="alert" role="alert">
                        <span id="testConnectionMessage"></span>
                    </div>
                    <div class="form-group">
                        <label>连接日志</label>
                        <pre id="testConnectionLog" class="p-2 bg-dark text-light" style="max-height: 200px; overflow-y: auto;"></pre>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">关闭</button>
                <button type="button" class="btn btn-primary" id="startTestBtn">开始测试</button>
            </div>
        </div>
    </div>
</div>

<!-- 删除确认模态框 -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1" role="dialog" aria-labelledby="deleteConfirmModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteConfirmModalLabel">确认删除</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p>确定要删除选中的SSH凭证吗？此操作不可恢复。</p>
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle"></i> 注意：删除凭证后，相关主机将无法使用此凭证进行连接。
                </div>
                <div id="deleteCredentialList">
                    <!-- 要删除的凭证列表 -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">确认删除</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    $(function () {
        // 初始化Select2
        $('.select2').select2({
            theme: 'bootstrap4'
        });
        
        // 加载主机选项
        loadHostOptions();
        
        // 加载凭证列表
        loadCredentials();
        
        // 搜索按钮点击事件
        $('#searchBtn').click(function() {
            loadCredentials();
        });
        
        // 全选/取消全选
        $('#selectAll').change(function() {
            $('.credential-checkbox').prop('checked', $(this).prop('checked'));
        });
        
        // 认证类型切换事件
        $('input[name="auth_type"]').change(function() {
            if ($(this).val() === 'password') {
                $('#passwordAuthSection').show();
                $('#keyAuthSection').hide();
            } else {
                $('#passwordAuthSection').hide();
                $('#keyAuthSection').show();
            }
        });
        
        // 密码显示/隐藏切换
        $('.toggle-password').click(function() {
            var input = $(this).closest('.input-group').find('input');
            if (input.attr('type') === 'password') {
                input.attr('type', 'text');
                $(this).find('i').removeClass('fa-eye').addClass('fa-eye-slash');
            } else {
                input.attr('type', 'password');
                $(this).find('i').removeClass('fa-eye-slash').addClass('fa-eye');
            }
        });
        
        // 保存凭证按钮点击事件
        $('#saveCredentialBtn').click(function() {
            saveCredential();
        });
        
        // 测试凭证按钮点击事件
        $('#testCredentialBtn').click(function() {
            prepareTestConnection();
        });
        
        // 开始测试按钮点击事件
        $('#startTestBtn').click(function() {
            testConnection();
        });
        
        // 确认删除按钮点击事件
        $('#confirmDeleteBtn').click(function() {
            deleteSelectedCredentials();
        });
    });
    
    // 加载凭证列表
    function loadCredentials(page = 1) {
        // 获取搜索条件
        var search = $('#searchInput').val();
        
        // 模拟AJAX请求，实际项目中应该调用后端API
        // $.ajax({
        //     url: '/hosts/api/credentials/',
        //     type: 'GET',
        //     data: {
        //         search: search,
        //         page: page
        //     },
        //     success: function(response) {
        //         renderCredentialTable(response);
        //     },
        //     error: function(error) {
        //         toastr.error('加载SSH凭证列表失败');
        //     }
        // });
        
        // 模拟数据
        var mockData = {
            count: 10,
            next: page < 2 ? '/hosts/api/credentials/?page=' + (page + 1) : null,
            previous: page > 1 ? '/hosts/api/credentials/?page=' + (page - 1) : null,
            results: [
                {
                    id: 1,
                    name: '生产环境root用户',
                    username: 'root',
                    auth_type: 'password',
                    host_count: 8,
                    created_by: '管理员',
                    created_at: '2023-06-01T09:00:00Z'
                },
                {
                    id: 2,
                    name: '测试环境admin用户',
                    username: 'admin',
                    auth_type: 'password',
                    host_count: 5,
                    created_by: '管理员',
                    created_at: '2023-06-01T09:30:00Z'
                },
                {
                    id: 3,
                    name: '开发环境deploy用户',
                    username: 'deploy',
                    auth_type: 'key',
                    host_count: 3,
                    created_by: '管理员',
                    created_at: '2023-06-01T10:00:00Z'
                },
                {
                    id: 4,
                    name: 'Windows管理员',
                    username: 'administrator',
                    auth_type: 'password',
                    host_count: 2,
                    created_by: '管理员',
                    created_at: '2023-06-01T10:30:00Z'
                },
                {
                    id: 5,
                    name: '数据库服务器',
                    username: 'dbadmin',
                    auth_type: 'key',
                    host_count: 3,
                    created_by: '管理员',
                    created_at: '2023-06-02T09:00:00Z'
                }
            ]
        };
        
        renderCredentialTable(mockData, page);
    }
    
    // 渲染凭证表格
    function renderCredentialTable(data, currentPage) {
        var tableBody = $('#credentialTableBody');
        tableBody.empty();
        
        // 渲染凭证数据
        $.each(data.results, function(index, credential) {
            var createdAt = new Date(credential.created_at).toLocaleString();
            var authTypeText = credential.auth_type === 'password' ? '密码认证' : '密钥认证';
            var authTypeIcon = credential.auth_type === 'password' ? 'fa-key' : 'fa-file-alt';
            
            var row = '<tr>' +
                '<td><input type="checkbox" class="credential-checkbox" value="' + credential.id + '"></td>' +
                '<td>' + credential.name + '</td>' +
                '<td>' + credential.username + '</td>' +
                '<td><i class="fas ' + authTypeIcon + '"></i> ' + authTypeText + '</td>' +
                '<td>' + credential.host_count + '</td>' +
                '<td>' + credential.created_by + '</td>' +
                '<td>' + createdAt + '</td>' +
                '<td>' +
                    '<button type="button" class="btn btn-sm btn-info view-credential" data-id="' + credential.id + '">' +
                        '<i class="fas fa-eye"></i>' +
                    '</button> ' +
                    '<button type="button" class="btn btn-sm btn-primary edit-credential" data-id="' + credential.id + '">' +
                        '<i class="fas fa-edit"></i>' +
                    '</button> ' +
                    '<button type="button" class="btn btn-sm btn-danger delete-credential" data-id="' + credential.id + '" data-name="' + credential.name + '">' +
                        '<i class="fas fa-trash"></i>' +
                    '</button>' +
                '</td>' +
            '</tr>';
            
            tableBody.append(row);
        });
        
        // 更新分页信息
        var start = (currentPage - 1) * 10 + 1;
        var end = start + data.results.length - 1;
        $('#paginationInfo').text('显示第 ' + start + ' 至 ' + end + ' 项，共 ' + data.count + ' 项');
        
        // 更新分页控件
        renderPagination(data, currentPage);
        
        // 绑定查看、编辑和删除按钮事件
        bindCredentialActions();
    }
    
    // 渲染分页控件
    function renderPagination(data, currentPage) {
        var pagination = $('#pagination ul');
        pagination.empty();
        
        // 上一页按钮
        var prevDisabled = !data.previous ? 'disabled' : '';
        pagination.append(
            '<li class="paginate_button page-item previous ' + prevDisabled + '">' +
                '<a href="#" class="page-link" data-page="' + (currentPage - 1) + '">上一页</a>' +
            '</li>'
        );
        
        // 页码按钮
        var totalPages = Math.ceil(data.count / 10);
        for (var i = 1; i <= totalPages; i++) {
            var active = i === currentPage ? 'active' : '';
            pagination.append(
                '<li class="paginate_button page-item ' + active + '">' +
                    '<a href="#" class="page-link" data-page="' + i + '">' + i + '</a>' +
                '</li>'
            );
        }
        
        // 下一页按钮
        var nextDisabled = !data.next ? 'disabled' : '';
        pagination.append(
            '<li class="paginate_button page-item next ' + nextDisabled + '">' +
                '<a href="#" class="page-link" data-page="' + (currentPage + 1) + '">下一页</a>' +
            '</li>'
        );
        
        // 绑定分页按钮点击事件
        $('.page-link').click(function(e) {
            e.preventDefault();
            if (!$(this).parent().hasClass('disabled')) {
                var page = $(this).data('page');
                loadCredentials(page);
            }
        });
    }
    
    // 绑定凭证操作按钮事件
    function bindCredentialActions() {
        // 查看凭证详情
        $('.view-credential').click(function() {
            var credentialId = $(this).data('id');
            viewCredentialDetail(credentialId);
        });
        
        // 编辑凭证
        $('.edit-credential').click(function() {
            var credentialId = $(this).data('id');
            editCredential(credentialId);
        });
        
        // 删除凭证
        $('.delete-credential').click(function() {
            var credentialId = $(this).data('id');
            var credentialName = $(this).data('name');
            showDeleteConfirm([{id: credentialId, name: credentialName}]);
        });
    }
    
    // 加载主机选项
    function loadHostOptions() {
        // 模拟AJAX请求，实际项目中应该调用后端API
        // $.ajax({
        //     url: '/hosts/api/hosts/',
        //     type: 'GET',
        //     data: {
        //         page_size: 100
        //     },
        //     success: function(response) {
        //         renderHostOptions(response.results);
        //     },
        //     error: function(error) {
        //         toastr.error('加载主机选项失败');
        //     }
        // });
        
        // 模拟数据
        var mockData = [
            {id: 1, hostname: 'web-server-01', ip_address: '192.168.1.101'},
            {id: 2, hostname: 'db-server-01', ip_address: '192.168.1.102'},
            {id: 3, hostname: 'app-server-01', ip_address: '192.168.1.103'},
            {id: 4, hostname: 'win-server-01', ip_address: '192.168.1.104'},
            {id: 5, hostname: 'cache-server-01', ip_address: '192.168.1.105'}
        ];
        
        renderHostOptions(mockData);
    }
    
    // 渲染主机选项
    function renderHostOptions(hosts) {
        var hostsSelect = $('#hosts');
        var testHostSelect = $('#test_host');
        
        // 清空现有选项
        hostsSelect.empty();
        testHostSelect.find('option:not(:first)').remove();
        
        // 添加选项
        $.each(hosts, function(index, host) {
            var optionText = host.hostname + ' (' + host.ip_address + ')';
            hostsSelect.append('<option value="' + host.id + '">' + optionText + '</option>');
            testHostSelect.append('<option value="' + host.id + '">' + optionText + '</option>');
        });
    }
    
    // 保存凭证
    function saveCredential() {
        // 获取表单数据
        var authType = $('input[name="auth_type"]:checked').val();
        var formData = {
            name: $('#name').val(),
            username: $('#username').val(),
            auth_type: authType,
            hosts: $('#hosts').val(),
            description: $('#description').val()
        };
        
        if (authType === 'password') {
            formData.password = $('#password').val();
        } else {
            formData.private_key = $('#private_key').val();
            formData.passphrase = $('#passphrase').val();
        }
        
        // 表单验证
        if (!formData.name) {
            toastr.error('凭证名称不能为空');
            return;
        }
        
        if (!formData.username) {
            toastr.error('用户名不能为空');
            return;
        }
        
        if (authType === 'password' && !formData.password) {
            toastr.error('密码不能为空');
            return;
        }
        
        if (authType === 'key' && !formData.private_key) {
            toastr.error('私钥不能为空');
            return;
        }
        
        // 判断是新增还是编辑
        var credentialId = $('#saveCredentialBtn').data('id');
        var url = '/hosts/api/credentials/';
        var method = 'POST';
        
        if (credentialId) {
            url += credentialId + '/';
            method = 'PUT';
        }
        
        // 模拟AJAX请求，实际项目中应该调用后端API
        // $.ajax({
        //     url: url,
        //     type: method,
        //     data: JSON.stringify(formData),
        //     contentType: 'application/json',
        //     success: function(response) {
        //         $('#addCredentialModal').modal('hide');
        //         toastr.success(credentialId ? 'SSH凭证更新成功' : 'SSH凭证添加成功');
        //         loadCredentials();
        //     },
        //     error: function(error) {
        //         toastr.error(credentialId ? 'SSH凭证更新失败' : 'SSH凭证添加失败');
        //     }
        // });
        
        // 模拟成功响应
        $('#addCredentialModal').modal('hide');
        toastr.success(credentialId ? 'SSH凭证更新成功' : 'SSH凭证添加成功');
        loadCredentials();
    }
    
    // 查看凭证详情
    function viewCredentialDetail(credentialId) {
        // 模拟AJAX请求，实际项目中应该调用后端API
        // $.ajax({
        //     url: '/hosts/api/credentials/' + credentialId + '/',
        //     type: 'GET',
        //     success: function(response) {
        //         renderCredentialDetail(response);
        //         loadCredentialHosts(credentialId);
        //         $('#credentialDetailModal').modal('show');
        //     },
        //     error: function(error) {
        //         toastr.error('获取SSH凭证详情失败');
        //     }
        // });
        
        // 模拟数据
        var mockData = {
            id: credentialId,
            name: '生产环境root用户',
            username: 'root',
            auth_type: 'password',
            host_count: 8,
            description: '用于生产环境服务器的root用户凭证',
            created_by: '管理员',
            created_at: '2023-06-01T09:00:00Z'
        };
        
        renderCredentialDetail(mockData);
        loadCredentialHosts(credentialId);
        $('#credentialDetailModal').modal('show');
    }
    
    // 渲染凭证详情
    function renderCredentialDetail(credential) {
        var createdAt = new Date(credential.created_at).toLocaleString();
        var authTypeText = credential.auth_type === 'password' ? '密码认证' : '密钥认证';
        
        var detailHtml = '<div class="row">' +
            '<div class="col-md-6">' +
                '<p><strong>名称：</strong>' + credential.name + '</p>' +
                '<p><strong>用户名：</strong>' + credential.username + '</p>' +
                '<p><strong>认证类型：</strong>' + authTypeText + '</p>' +
            '</div>' +
            '<div class="col-md-6">' +
                '<p><strong>关联主机数：</strong>' + credential.host_count + '</p>' +
                '<p><strong>创建人：</strong>' + credential.created_by + '</p>' +
                '<p><strong>创建时间：</strong>' + createdAt + '</p>' +
            '</div>' +
        '</div>' +
        '<div class="row mt-3">' +
            '<div class="col-12">' +
                '<p><strong>描述：</strong></p>' +
                '<p>' + (credential.description || '无') + '</p>' +
            '</div>' +
        '</div>';
        
        $('#credentialDetailContent').html(detailHtml);
        
        // 设置编辑按钮的凭证ID
        $('#editCredentialBtn').data('id', credential.id);
    }
    
    // 加载凭证关联的主机列表
    function loadCredentialHosts(credentialId) {
        // 模拟AJAX请求，实际项目中应该调用后端API
        // $.ajax({
        //     url: '/hosts/api/credentials/' + credentialId + '/hosts/',
        //     type: 'GET',
        //     success: function(response) {
        //         renderCredentialHosts(response);
        //     },
        //     error: function(error) {
        //         toastr.error('加载凭证关联主机列表失败');
        //     }
        // });
        
        // 模拟数据
        var mockData = [
            {
                id: 1,
                hostname: 'web-server-01',
                ip_address: '192.168.1.101',
                status: 'online',
                os_type: 'linux'
            },
            {
                id: 2,
                hostname: 'db-server-01',
                ip_address: '192.168.1.102',
                status: 'online',
                os_type: 'linux'
            },
            {
                id: 3,
                hostname: 'app-server-01',
                ip_address: '192.168.1.103',
                status: 'offline',
                os_type: 'linux'
            }
        ];
        
        renderCredentialHosts(mockData);
    }
    
    // 渲染凭证关联的主机列表
    function renderCredentialHosts(hosts) {
        var tableBody = $('#credentialHostsTableBody');
        tableBody.empty();
        
        if (hosts.length === 0) {
            tableBody.append('<tr><td colspan="4" class="text-center">该凭证暂未关联主机</td></tr>');
            return;
        }
        
        // 渲染主机数据
        $.each(hosts, function(index, host) {
            var statusClass = '';
            var statusText = '';
            
            switch(host.status) {
                case 'online':
                    statusClass = 'badge-success';
                    statusText = '在线';
                    break;
                case 'offline':
                    statusClass = 'badge-danger';
                    statusText = '离线';
                    break;
                default:
                    statusClass = 'badge-secondary';
                    statusText = '未知';
            }
            
            var row = '<tr>' +
                '<td>' + host.hostname + '</td>' +
                '<td>' + host.ip_address + '</td>' +
                '<td><span class="badge ' + statusClass + '">' + statusText + '</span></td>' +
                '<td>' + (host.os_type === 'linux' ? 'Linux' : (host.os_type === 'windows' ? 'Windows' : '其他')) + '</td>' +
            '</tr>';
            
            tableBody.append(row);
        });
    }
    
    // 编辑凭证
    function editCredential(credentialId) {
        // 模拟AJAX请求，实际项目中应该调用后端API
        // $.ajax({
        //     url: '/hosts/api/credentials/' + credentialId + '/',
        //     type: 'GET',
        //     success: function(response) {
        //         fillCredentialForm(response);
        //         $('#addCredentialModalLabel').text('编辑SSH凭证');
        //         $('#addCredentialModal').modal('show');
        //     },
        //     error: function(error) {
        //         toastr.error('获取SSH凭证信息失败');
        //     }
        // });
        
        // 模拟数据
        var mockData = {
            id: credentialId,
            name: '生产环境root用户',
            username: 'root',
            auth_type: 'password',
            hosts: [1, 2, 3],
            description: '用于生产环境服务器的root用户凭证'
        };
        
        fillCredentialForm(mockData);
        $('#addCredentialModalLabel').text('编辑SSH凭证');
        $('#addCredentialModal').modal('show');
    }
    
    // 填充凭证表单
    function fillCredentialForm(credential) {
        $('#name').val(credential.name);
        $('#username').val(credential.username);
        $('#description').val(credential.description);
        
        // 设置认证类型
        if (credential.auth_type === 'password') {
            $('#authTypePassword').prop('checked', true).trigger('change');
        } else {
            $('#authTypeKey').prop('checked', true).trigger('change');
        }
        
        // 设置关联主机
        $('#hosts').val(credential.hosts).trigger('change');
        
        // 设置保存按钮的凭证ID
        $('#saveCredentialBtn').data('id', credential.id);
    }
    
    // 准备测试连接
    function prepareTestConnection() {
        // 重置测试结果
        $('#testConnectionResult').hide();
        $('#testConnectionMessage').text('');
        $('#testConnectionLog').text('');
        
        // 获取当前表单中的主机选项
        var selectedHosts = $('#hosts').val();
        if (selectedHosts && selectedHosts.length > 0) {
            $('#test_host').val(selectedHosts[0]);
        }
        
        // 显示测试连接模态框
        $('#testConnectionModal').modal('show');
    }
    
    // 测试连接
    function testConnection() {
        // 获取测试表单数据
        var hostId = $('#test_host').val();
        var port = $('#test_port').val();
        
        // 表单验证
        if (!hostId) {
            toastr.error('请选择要测试连接的主机');
            return;
        }
        
        // 获取凭证表单数据
        var authType = $('input[name="auth_type"]:checked').val();
        var username = $('#username').val();
        var password = authType === 'password' ? $('#password').val() : '';
        var privateKey = authType === 'key' ? $('#private_key').val() : '';
        var passphrase = authType === 'key' ? $('#passphrase').val() : '';
        
        // 表单验证
        if (!username) {
            toastr.error('用户名不能为空');
            return;
        }
        
        if (authType === 'password' && !password) {
            toastr.error('密码不能为空');
            return;
        }
        
        if (authType === 'key' && !privateKey) {
            toastr.error('私钥不能为空');
            return;
        }
        
        // 显示测试中状态
        $('#startTestBtn').prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> 测试中...');
        $('#testConnectionResult').show();
        $('#testConnectionMessage').text('正在连接主机，请稍候...');
        $('#testConnectionMessage').parent().removeClass('alert-success alert-danger').addClass('alert-info');
        $('#testConnectionLog').text('正在初始化SSH连接...');
        
        // 模拟AJAX请求，实际项目中应该调用后端API
        // $.ajax({
        //     url: '/hosts/api/test-ssh-connection/',
        //     type: 'POST',
        //     data: JSON.stringify({
        //         host_id: hostId,
        //         port: port,
        //         username: username,
        //         auth_type: authType,
        //         password: password,
        //         private_key: privateKey,
        //         passphrase: passphrase
        //     }),
        //     contentType: 'application/json',
        //     success: function(response) {
        //         showTestResult(response);
        //     },
        //     error: function(error) {
        //         showTestError(error);
        //     }
        // });
        
        // 模拟测试过程
        setTimeout(function() {
            $('#testConnectionLog').append('\n尝试连接到主机...');
        }, 500);
        
        setTimeout(function() {
            $('#testConnectionLog').append('\n验证SSH凭证...');
        }, 1000);
        
        // 模拟随机成功或失败
        var success = Math.random() > 0.3;
        
        setTimeout(function() {
            if (success) {
                showTestResult({
                    success: true,
                    message: '连接成功',
                    log: '连接到主机成功\n验证SSH凭证成功\n执行测试命令: hostname\n命令执行成功，输出: web-server-01\n连接测试完成'
                });
            } else {
                showTestError({
                    responseJSON: {
                        success: false,
                        message: '连接失败',
                        log: '连接到主机成功\n验证SSH凭证失败: 认证失败，请检查用户名和密码\n连接测试失败'
                    }
                });
            }
        }, 2000);
    }
    
    // 显示测试结果
    function showTestResult(response) {
        $('#startTestBtn').prop('disabled', false).text('开始测试');
        
        if (response.success) {
            $('#testConnectionMessage').text('连接成功: ' + response.message);
            $('#testConnectionMessage').parent().removeClass('alert-info alert-danger').addClass('alert-success');
        } else {
            $('#testConnectionMessage').text('连接失败: ' + response.message);
            $('#testConnectionMessage').parent().removeClass('alert-info alert-success').addClass('alert-danger');
        }
        
        $('#testConnectionLog').text(response.log);
    }
    
    // 显示测试错误
    function showTestError(error) {
        $('#startTestBtn').prop('disabled', false).text('开始测试');
        
        var errorMessage = '连接失败';
        var errorLog = '测试过程中发生错误';
        
        if (error.responseJSON) {
            errorMessage = error.responseJSON.message || errorMessage;
            errorLog = error.responseJSON.log || errorLog;
        }
        
        $('#testConnectionMessage').text('连接失败: ' + errorMessage);
        $('#testConnectionMessage').parent().removeClass('alert-info alert-success').addClass('alert-danger');
        $('#testConnectionLog').text(errorLog);
    }
    
    // 显示删除确认对话框
    function showDeleteConfirm(credentials) {
        var credentialListHtml = '<ul>';
        $.each(credentials, function(index, credential) {
            credentialListHtml += '<li>' + credential.name + '</li>';
        });
        credentialListHtml += '</ul>';
        
        $('#deleteCredentialList').html(credentialListHtml);
        $('#confirmDeleteBtn').data('credentials', credentials.map(function(credential) { return credential.id; }));
        $('#deleteConfirmModal').modal('show');
    }
    
    // 删除选中的凭证
    function deleteSelectedCredentials() {
        var credentialIds = $('#confirmDeleteBtn').data('credentials');
        
        // 模拟AJAX请求，实际项目中应该调用后端API
        // $.ajax({
        //     url: '/hosts/api/credentials/batch-delete/',
        //     type: 'POST',
        //     data: JSON.stringify({credential_ids: credentialIds}),
        //     contentType: 'application/json',
        //     success: function(response) {
        //         $('#deleteConfirmModal').modal('hide');
        //         toastr.success('SSH凭证删除成功');
        //         loadCredentials();
        //     },
        //     error: function(error) {
        //         toastr.error('SSH凭证删除失败');
        //     }
        // });
        
        // 模拟成功响应
        $('#deleteConfirmModal').modal('hide');
        toastr.success('SSH凭证删除成功');
        loadCredentials();
    }
</script>
{% endblock %}